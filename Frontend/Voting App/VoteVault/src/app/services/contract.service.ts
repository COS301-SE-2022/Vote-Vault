import { Injectable } from '@angular/core';
import {ContractFactory, ethers, providers} from 'ethers';
import { DataService } from '../data.service';

@Injectable({
  providedIn: 'root'
})
export class ContractService {

  private contractABI = '[{"constant":true,"inputs":[],"name":"startDate","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"},{"name":"","type":"uint256"}],"name":"voteCount","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"endDate","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"electionID","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"inputs":[{"name":"id","type":"string"},{"name":"sd","type":"uint256"},{"name":"ed","type":"uint256"},{"name":"numCandidates","type":"uint256[]"}],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"constant":false,"inputs":[{"name":"id","type":"string"},{"name":"age","type":"uint256"},{"name":"gender","type":"string"}],"name":"registerUser","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"id","type":"string"},{"name":"votes","type":"uint256[]"}],"name":"addVote","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"getId","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"id","type":"string"}],"name":"updateId","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"}]'
  private contractBytecode = '0x60806040523480156200001157600080fd5b506040516200100f3803806200100f833981018060405260808110156200003757600080fd5b8101908080516401000000008111156200005057600080fd5b828101905060208101848111156200006757600080fd5b81518560018202830111640100000000821117156200008557600080fd5b505092919060200180519060200190929190805190602001909291908051640100000000811115620000b657600080fd5b82810190506020810184811115620000cd57600080fd5b8151856020820283011164010000000082111715620000eb57600080fd5b505092919050505083600190805190602001906200010b9291906200020c565b50826002819055508160038190555060036040519080825280602002602001820160405280156200015157816020015b60608152602001906001900390816200013b5790505b50600090805190602001906200016992919062000293565b5060008090505b6003811015620002015781818151811015156200018957fe5b90602001906020020151604051908082528060200260200182016040528015620001c25781602001602082028038833980820191505090505b50600082815481101515620001d357fe5b906000526020600020019080519060200190620001f2929190620002fa565b50808060010191505062000170565b50505050506200041a565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106200024f57805160ff191683800117855562000280565b8280016001018555821562000280579182015b828111156200027f57825182559160200191906001019062000262565b5b5090506200028f91906200034c565b5090565b828054828255906000526020600020908101928215620002e7579160200282015b82811115620002e6578251829080519060200190620002d592919062000374565b5091602001919060010190620002b4565b5b509050620002f69190620003c6565b5090565b82805482825590600052602060002090810192821562000339579160200282015b82811115620003385782518255916020019190600101906200031b565b5b5090506200034891906200034c565b5090565b6200037191905b808211156200036d57600081600090555060010162000353565b5090565b90565b828054828255906000526020600020908101928215620003b3579160200282015b82811115620003b257825182559160200191906001019062000395565b5b509050620003c291906200034c565b5090565b620003f491905b80821115620003f05760008181620003e69190620003f7565b50600101620003cd565b5090565b90565b50805460008255906000526020600020908101906200041791906200034c565b50565b610be5806200042a6000396000f3fe60806040526004361061008e576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680630b97bc86146100935780635295da5d146100be5780635d1ca6311461021a5780635ede1373146102aa57806362609da414610372578063ba329414146104db578063c24a0f8b14610534578063f8e78e9a1461055f575b600080fd5b34801561009f57600080fd5b506100a86105ef565b6040518082815260200191505060405180910390f35b3480156100ca57600080fd5b50610218600480360360408110156100e157600080fd5b81019080803590602001906401000000008111156100fe57600080fd5b82018360208201111561011057600080fd5b8035906020019184600183028401116401000000008311171561013257600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f8201169050808301925050505050505091929192908035906020019064010000000081111561019557600080fd5b8201836020820111156101a757600080fd5b803590602001918460208302840111640100000000831117156101c957600080fd5b919080806020026020016040519081016040528093929190818152602001838360200280828437600081840152601f19601f8201169050808301925050505050505091929192905050506105f5565b005b34801561022657600080fd5b5061022f6107de565b6040518080602001828103825283818151815260200191508051906020019080838360005b8381101561026f578082015181840152602081019050610254565b50505050905090810190601f16801561029c5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b3480156102b657600080fd5b50610370600480360360208110156102cd57600080fd5b81019080803590602001906401000000008111156102ea57600080fd5b8201836020820111156102fc57600080fd5b8035906020019184600183028401116401000000008311171561031e57600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f820116905080830192505050505050509192919290505050610880565b005b34801561037e57600080fd5b506104d96004803603606081101561039557600080fd5b81019080803590602001906401000000008111156103b257600080fd5b8201836020820111156103c457600080fd5b803590602001918460018302840111640100000000831117156103e657600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f820116905080830192505050505050509192919290803590602001909291908035906020019064010000000081111561045357600080fd5b82018360208201111561046557600080fd5b8035906020019184600183028401116401000000008311171561048757600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f82011690508083019250505050505050919291929050505061089a565b005b3480156104e757600080fd5b5061051e600480360360408110156104fe57600080fd5b81019080803590602001909291908035906020019092919050505061099b565b6040518082815260200191505060405180910390f35b34801561054057600080fd5b506105496109d6565b6040518082815260200191505060405180910390f35b34801561056b57600080fd5b506105746109dc565b6040518080602001828103825283818151815260200191508051906020019080838360005b838110156105b4578082015181840152602081019050610599565b50505050905090810190601f1680156105e15780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b60025481565b6005826040518082805190602001908083835b60208310151561062d5780518252602082019150602081019050602083039250610608565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060009054906101000a900460ff161515156106e3576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252600d8152602001807f416c726561647920766f7465640000000000000000000000000000000000000081525060200191505060405180910390fd5b60008090505b600381101561075557600160008281548110151561070357fe5b90600052602060002001838381518110151561071b57fe5b9060200190602002015181548110151561073157fe5b906000526020600020016000828254019250508190555080806001019150506106e9565b5060016005836040518082805190602001908083835b602083101515610790578051825260208201915060208101905060208303925061076b565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060006101000a81548160ff0219169083151502179055505050565b606060018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156108765780601f1061084b57610100808354040283529160200191610876565b820191906000526020600020905b81548152906001019060200180831161085957829003601f168201915b5050505050905090565b8060019080519060200190610896929190610a7a565b5050565b60006005846040518082805190602001908083835b6020831015156108d457805182526020820191506020810190506020830392506108af565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060006101000a81548160ff021916908315150217905550610926610afa565b604080519081016040528084815260200183815250905060048190806001815401808255809150509060018203906000526020600020906002020160009091929091909150600082015181600001556020820151816001019080519060200190610991929190610b14565b5050505050505050565b6000828154811015156109aa57fe5b90600052602060002001818154811015156109c157fe5b90600052602060002001600091509150505481565b60035481565b60018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610a725780601f10610a4757610100808354040283529160200191610a72565b820191906000526020600020905b815481529060010190602001808311610a5557829003601f168201915b505050505081565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10610abb57805160ff1916838001178555610ae9565b82800160010185558215610ae9579182015b82811115610ae8578251825591602001919060010190610acd565b5b509050610af69190610b94565b5090565b604080519081016040528060008152602001606081525090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10610b5557805160ff1916838001178555610b83565b82800160010185558215610b83579182015b82811115610b82578251825591602001919060010190610b67565b5b509050610b909190610b94565b5090565b610bb691905b80821115610bb2576000816000905550600101610b9a565b5090565b9056fea165627a7a723058204edef3a1dd5661d4f920e16ef6defa2caf82979008dd2fd82014fda35640427c0029'
  private privateKey = '0x1bfdd10e791617c7e8e9c7d0a451b45f1fcf07c831504d8f2fa0727a2b166cd2'
  private alcProvider = null
  private signer = null

  constructor(private dataService : DataService) {
    this.alcProvider = new ethers.providers.AlchemyProvider("goerli", "OvCjMEF-_qv95PPGX2i14JE1A-3nSIl8")

    this.signer = new ethers.Wallet(this.privateKey, this.alcProvider)

    // this.deploy()
  }

  //Deploys contract to blockchain and returns ID
  async deploy(id, sd, ed, sizes) : Promise<String> {
    console.log("Deploying...")
    const contractFactory = new ContractFactory(this.contractABI, this.contractBytecode, this.signer)
 
    const contract = await contractFactory.deploy(id, sd, ed, sizes)

    await contract.deployed()
    console.log("Success! : ", await contract.address)

    return await contract.address
    // const electionID = await contract.electionID()
    // console.log("ID : " + electionID)
    // const startDate = await contract.startDate()
    // console.log("StartDate : " + startDate)
  }

  async addVoter(contractAddress, voter) {
    const contract = new ethers.Contract(contractAddress, this.contractABI, this.signer)

    try {
      const tx = await contract.registerUser(voter.IDnum, voter.Age, voter.Gender, {gasLimit : 250000})
      await tx.wait()
    }
    catch(error) {
      console.error(error)
    }
  }

  //Add a vote to the specified election, at specified indices
  async addVote(contractAddress, votes) {
    const contract = new ethers.Contract(contractAddress, this.contractABI, this.signer)

    //Call method
    try {
      const tx = await contract.addVote(this.dataService.voterId, votes, {gasLimit : 250000})
      await tx.wait()
    }
    catch(error) {
      console.error(error)
    }
  }

  // async 


}
